# 互联网MySql开发规范


## 命名规范

- 库名、表名、字段名禁止超过32个字符。最好是通过名字就知道业务含义
- 库名、表名、字段名禁止使用MySQL保留字
- 临时库、表名必须以tmp为前缀，并以日期为后缀
- 备份库、表必须以bak为前缀，并以日期为后缀

## 开发设计规范

- 使用INNODB存储引擎
- 表字符集使用UTF8
- 所有表都需要添加注释
- 单表数据量建议控制在5000W以内
- 不在数据库中存储图、文件等大数据
- 禁使用分区表
- 拆分大字段和访问频率低的字段，分离冷热数据
- 用HASH进散表，表名后缀使进制数，下标从0开始
- 按日期时间分表需符合YYYY[MM][DD][HH]格式
- 尽可能不使用TEXT、BLOB类型
- 用DECIMAL代替FLOAT和DOUBLE存储精确浮点数
- 越简单越好：将字符转化为数字、使用TINYINT来代替ENUM类型
- 所有字段均定义为NOT NULL
- 使用UNSIGNED存储非负整数
- 使用timestamp存储时间
- 使用INT UNSIGNED存储IPV4
- 使用VARBINARY存储大小写敏感的变长字符串
- 禁止在数据库中存储明文密码，把密码加密后存储
- 如果数值字段没有那么大，就不要用 bigint
- 避免使用NULL字段，NULL字段很难查询优化，NULL字段的索引需要额外空间，NULL字段的复合索引无效
- 少用text/blob，varchar的性能会比text高很多，实在避免不了blob，请拆表

## 索引规范

1. 索引的数量要控制：
   - 单张表中索引数量建议不超过5个
   - 单个索引中的字段数不超过5个
   - 对字符串使用前缀索引，前缀索引长度不超过8个字符
   - 建议优先考虑前缀索引，必要时可添加伪列并建立索引
2. 主键准则
   - 表必须有主键
   - 不使用更新频繁的列作为主键
   - 尽量不选择字符串列作为主键
   - 不使用UUID MD5 HASH这些作为主键(数值太离散了)
   - 建议选择自增或发号器
3. 重要的SQL必须被索引，比如：
   - UPDATE、DELETE语句的WHERE条件列
   - ORDER BY、GROUP BY、DISTINCT的字段
4. 多表JOIN的字段注意以下：
   - 区分度最大的字段放在前面
   - 避免冗余和重复索引
   - 索引要综合评估数据密度和分布以及考虑查询和更新比例
5. 索引禁忌
   - 不在低基数列上建立索引，例如“性别”
   - 不在索引列进行数学运算和函数运算
6. 尽量不使用外键
   - 外键用来保护参照完整性，可在业务端实现
   - 对父表和子表的操作会相互影响，降低可用性
7. 索引命名：非唯一索引必须以 idx_字段1_字段2命名，唯一所以必须以uniq_字段1_字段2命名，索引名称必须全部小写
8. 新建的唯一索引必须不能和主键重复
9. 索引字段的默认值不能为NULL，要改为其他的default或者空。NULL非常影响索引的查询效率
10. 反复查看与表相关的SQL，符合最左前缀的特点建立索引。多条字段重复的语句，要修改语句条件字段的顺序，为其建立一条联合索引，减少索引数量
11. 能使用唯一索引就要使用唯一索引，提高查询效率
12. 研发要经常使用explain，如果发现索引选择性差，必须学会使用hint

## SQL语句规范

- sql语句尽可能简单，大的sql想办法拆成小的sql语句(充分利用QUERY CACHE和充分利用多核CPU)
- 事务要简单，整个事务的时间长度不要太长
- 避免使用触发器、函数、存储过程
- 降低业务耦合度，为sacle out、sharding留有余地
- 避免在数据库中进数学运算(MySQL不擅长数学运算和逻辑判断)
- 不要用select *，查询哪几个字段就select 这几个字段
- sql中使用到OR的改写为用 IN()   (or的效率没有in的效率高)
- in里面数字的个数建议控制在1000以内
- limit分页注意效率。Limit越大，效率越低
- 使用union all替代union
- 避免使大表的JOIN
- 使用group by 分组、自动排序
- 对数据的更新要打散后批量更新，不要一次更新太多数据
- 减少与数据库的交互次数
- 注意使用性能分析工具 Sql explain  /  showprofile   /    mysqlsla
- SQL语句要求所有研发，SQL关键字全部是大写，每个词只允许有一个空格
- SQL语句不可以出现隐式转换，比如 select id from 表 where id='1'
- 能不用NOT IN就不用NOTIN，坑太多了。。会把空和NULL给查出来
- 在SQL语句中，禁止使用前缀是%的like
- 不使用负向查询，如not in/like
- 关于分页查询：程序里建议合理使用分页来提高效率limit，offset较大要配合子查询使用
- 禁止在数据库中跑大查询
- 禁止使order by rand()
- 禁单条SQL语句同时更新多个表

## 流程规范

- 禁止在线上做数据库压力测试
- 禁从测试、开发环境直连数据库
- 所有的建表操作需要提前告知该表涉及的查询sql；
- 所有的建表需要确定建立哪些索引后才可以建表上线；
- 所有的改表结构、加索引操作都需要将涉及到所改表的查询sql发出来告知DBA等相关人员；
- 在建新表加字段之前，要求研发至少要提前3天邮件出来，给dba们评估、优化和审核的时间
- 批量导入、导出数据必须提前通知DBA协助观察
- 禁在线上从库执行后台管理和统计类查询
- 禁有super权限的应用程序账号存在
- 推广活动或上线新功能必须提前通知DBA进行流量评估
- 不在业务高峰期批量更新、查询数据库

# 数据库版本控制规范

## 规范以及注意事项

​	**重要：通过版本控制工程修改数据库，提交数据库变更一定要本地执行验证通过！！！**

- 数据库变更需提交 changeSet
- ChangeSet id 使用 [日期]-[姓名]-[序号]，如 20210603-shixiong-1（目的：合并代码的时候序号不冲突）
- sql 禁止包含 schema 名称 （目的：真正部署的时候 库和用户都不一定是 VOSP）
- 已经部署至测试及预发环境的 ChangeSet 严禁修改。（原因：框架限制历史SQL不能修改，改了之后校验和变化会执行失败）
- 数据库初始化数据的 sql 在 sql/data 目录下，初始化数据在开发时不放入 changlog，每一版本单表仅有一个初始化数据的 SQL 文件即可，可直接修改，禁止在之前版本的初始化数据中直接修改。（原因：初始化数据变更频繁不适合用版本控制，更适合手动执行，什么情况下可用：初始化数据确定不变了，上线，可放入 changset 直接执行）
- 如果多张表的改动 每张表是一个单独的 sqlFile，并且要在 comments 里写明变更点
- changelog.yaml 起名规则跟需求版本号保持一致， 例如v1.6 需求 changelog 为 changelog-1.6.yaml。上线之后有BUG 需要提 SQL 修复的话，小版本号升级，例如 changelog-1.6.1.yaml。
- 不要随便升级项目liquibase版本，特别是大版本升级。不同版本 ChangeSet MD5SUM的算法不一样。

## 目录规则

- 按版本创建目录 例如 1.2.0 ，每个版本的 sql 放在对应版本文件夹下, 可新增模块文件夹，文件名需以数据库表名(大写)开头， 后跟数字，从100开始，并且按序递增: （目的：是为了一目了然看到 SQL 执行的先后顺序，并且同一张表的放在一块）

- 文件目录结构如下
  - 1.2.0
    - customer
      - CUSTOMER_100.sql
      - CUSTOMER_101.sql
    - article
      - ARTICLE_100.sql
      - ARTICLE_101.sql
      - ...

